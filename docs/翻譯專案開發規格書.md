# 翻譯專案開發規格書

## 專案概述

基於現有「面相專案」架構，開發一套自動化翻譯字幕工作流程系統。

### 目標
將英文影片自動生成中文字幕，套用到剪映模板中批量產出。

---

## 工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      翻譯專案工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 準備階段                                                      │
│     └── 使用者將英文影片放入 videos/raw 資料夾                     │
│                                                                  │
│  2. 語音識別 (Whisper)                                           │
│     ├── 讀取影片音軌                                              │
│     ├── Whisper 轉錄成英文字幕                                    │
│     └── 輸出: 帶時間軸的字幕資料 (SRT/JSON)                        │
│                                                                  │
│  3. 翻譯處理                                                      │
│     ├── 讀取英文字幕                                              │
│     ├── 呼叫翻譯 API (Google/DeepL/OpenAI)                       │
│     └── 輸出: 中文字幕 (保留時間軸)                                │
│                                                                  │
│  4. 剪映草稿生成                                                  │
│     ├── 複製「翻譯專案」模板                                       │
│     ├── 替換影片素材                                              │
│     ├── 根據時間軸生成字幕軌道                                     │
│     └── 套用字幕樣式 (字體、顏色、位置)                            │
│                                                                  │
│  5. 批量導出                                                      │
│     └── 使用現有 batch_export_faces.py 導出影片                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 技術架構

### 檔案結構

```
face-vid-template/
├── 翻譯專案/                    # 剪映模板 (字幕樣式範本)
│   └── draft_content.json
├── videos/
│   └── raw/                     # 待處理的英文影片
├── subtitles/                   # [新增] 字幕暫存
│   ├── {video_name}_en.srt      # 英文字幕
│   └── {video_name}_zh.srt      # 中文字幕
├── translation_config.json      # [新增] 翻譯設定檔
├── translate_video.py           # [新增] 主程式
└── subtitle_generator.py        # [新增] 字幕生成模組
```

### 核心模組

#### 1. `subtitle_generator.py` - 字幕生成模組

```python
class SubtitleGenerator:
    """Whisper 語音識別 + 翻譯"""

    def transcribe(video_path: str) -> List[SubtitleEntry]
        """使用 Whisper 轉錄影片"""

    def translate(entries: List[SubtitleEntry], target_lang: str) -> List[SubtitleEntry]
        """翻譯字幕內容"""

    def export_srt(entries: List[SubtitleEntry], output_path: str)
        """輸出 SRT 格式"""
```

#### 2. `translate_video.py` - 主程式

```python
class TranslationWorkflow:
    """翻譯影片工作流程"""

    def process_video(video_path: str) -> str
        """處理單個影片，返回生成的草稿名稱"""
        # 1. Whisper 轉錄
        # 2. 翻譯字幕
        # 3. 生成剪映草稿

    def batch_process(video_folder: str)
        """批量處理資料夾內所有影片"""
```

#### 3. `jianying_subtitle.py` - 剪映字幕模組

```python
class JianyingSubtitle:
    """剪映字幕軌道生成器"""

    def create_text_segment(text: str, start_time: int, end_time: int, style: dict) -> dict
        """創建單個字幕片段"""

    def add_subtitle_track(draft_data: dict, subtitles: List[SubtitleEntry]) -> dict
        """將字幕添加到草稿的字幕軌道"""
```

---

## 設定檔格式

### `translation_config.json`

```json
{
  "whisper": {
    "model": "base",
    "language": "en",
    "device": "cuda"
  },
  "translation": {
    "provider": "openai",
    "source_lang": "en",
    "target_lang": "zh-TW",
    "api_key_env": "OPENAI_API_KEY"
  },
  "subtitle_style": {
    "font": "思源黑體",
    "font_size": 12,
    "color": "#FFFFFF",
    "background_color": "#000000",
    "background_alpha": 0.7,
    "position_y": -0.8
  },
  "output": {
    "template_name": "翻譯專案",
    "output_prefix": "翻譯專案_"
  }
}
```

---

## 依賴套件

```
# requirements_translation.txt

# 語音識別
openai-whisper>=20231117
torch>=2.0.0

# 翻譯 API
openai>=1.0.0          # OpenAI GPT 翻譯
deepl>=1.16.0          # DeepL API (可選)
googletrans==4.0.0rc1  # Google 翻譯 (可選，免費但不穩定)

# 字幕處理
pysrt>=1.1.2
```

---

## 開發階段

### Phase 1: 基礎架構 (MVP)
- [ ] 設定檔結構設計
- [ ] Whisper 語音識別整合
- [ ] 基本字幕輸出 (SRT)
- [ ] 單影片處理流程

### Phase 2: 翻譯整合
- [ ] OpenAI GPT 翻譯整合
- [ ] 字幕時間軸對齊
- [ ] 翻譯品質優化 (上下文處理)

### Phase 3: 剪映整合
- [ ] 字幕軌道生成
- [ ] 字幕樣式套用 (從模板讀取)
- [ ] 影片替換整合

### Phase 4: 批量處理
- [ ] 批量影片處理
- [ ] 進度顯示
- [ ] 失敗重試機制
- [ ] 整合現有導出流程

### Phase 5: 優化
- [ ] GPU 加速 Whisper
- [ ] 翻譯快取 (避免重複翻譯)
- [ ] 字幕分段優化 (長句拆分)

---

## 使用方式 (預期)

### 命令行

```bash
# 處理單個影片
python translate_video.py video.mp4

# 批量處理
python translate_video.py --batch videos/raw

# 指定翻譯語言
python translate_video.py --source en --target zh-TW video.mp4

# 只生成字幕，不生成剪映草稿
python translate_video.py --subtitle-only video.mp4
```

### 批次檔

```bash
# translate.bat - 一鍵執行
python translate_video.py --batch videos/raw
```

---

## 字幕資料結構

```python
@dataclass
class SubtitleEntry:
    index: int           # 字幕序號
    start_time: float    # 開始時間 (秒)
    end_time: float      # 結束時間 (秒)
    text_original: str   # 原文
    text_translated: str # 譯文
```

### 剪映字幕片段結構

```json
{
  "material_id": "uuid",
  "target_timerange": {
    "start": 0,           // 微秒
    "duration": 2000000   // 微秒
  },
  "clip": {
    "transform": {"x": 0, "y": -0.8},
    "scale": {"x": 1, "y": 1}
  }
}
```

---

## 風險與注意事項

1. **Whisper 效能**
   - 長影片處理時間較長
   - 建議使用 GPU 加速
   - 可考慮分段處理

2. **翻譯品質**
   - 機器翻譯可能不準確
   - 建議保留原文供校對
   - 可考慮雙語字幕模式

3. **API 成本**
   - OpenAI API 按 token 計費
   - 建議加入快取機制
   - 可選用免費但限制多的 Google Translate

4. **字幕時間軸**
   - Whisper 時間軸可能有誤差
   - 需要處理過長/過短的字幕段

---

## 下一步

確認以上規格後，建議開發順序：

1. 先建立 `subtitle_generator.py` 測試 Whisper
2. 建立 `translation_config.json` 設定檔
3. 整合翻譯 API
4. 開發剪映字幕軌道生成
5. 整合成完整工作流程

---

*文件版本: v1.0*
*建立日期: 2024-12-18*
